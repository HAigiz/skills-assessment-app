{% extends "base.html" %}

{% block title %}Моя команда | SkillExam{% endblock %}

{% block extra_css %}
<style>
.team-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.team-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.team-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card-team {
    background: white;
    padding: 1.5rem;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    text-align: center;
}

.stat-card-team i {
    font-size: 2rem;
    color: #667eea;
    margin-bottom: 1rem;
}

.team-members-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.member-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.3s;
}

.member-card:hover {
    transform: translateY(-5px);
}

.member-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.member-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: white;
    color: #667eea;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
}

.member-info h3 {
    margin: 0;
    font-size: 1.2rem;
}

.member-info .role {
    font-size: 0.9rem;
    opacity: 0.9;
}

.member-stats {
    padding: 1rem 1.5rem;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    border-bottom: 1px solid #eee;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
}

.stat-label {
    font-size: 0.9rem;
    color: #666;
}

.member-actions {
    padding: 1rem 1.5rem;
    display: flex;
    gap: 0.5rem;
}

.btn-view {
    flex: 1;
    background: #667eea;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    text-decoration: none;
    font-size: 0.9rem;
}

.btn-view:hover {
    background: #5a6fd8;
    color: white;
}

.btn-assess {
    flex: 1;
    background: #4caf50;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-size: 0.9rem;
}

.btn-assess:hover {
    background: #43a047;
}

.empty-team {
    text-align: center;
    padding: 3rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.empty-team i {
    font-size: 3rem;
    color: #ccc;
    margin-bottom: 1rem;
}

.assessment-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}

.assessment-modal.show {
    display: flex;
}

.assessment-content {
    background: white;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    border-radius: 10px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.assessment-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.assessment-header h3 {
    margin: 0;
}

.close-assessment {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
}

.assessment-body {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
}

.skills-assessment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1rem;
}

.skill-assessment-item {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #eaeaea;
}

.skill-name {
    font-weight: bold;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.category-badge {
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.8rem;
}

.skill-description {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 1rem;
    min-height: 40px;
}

.score-section {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.score-label {
    font-size: 0.9rem;
    color: #666;
}

.score-value {
    font-weight: bold;
    color: #333;
}

.score-controls {
    display: flex;
    gap: 0.3rem;
    margin-top: 0.5rem;
}

.manager-score-btn {
    flex: 1;
    padding: 0.3rem;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.2s;
}

.manager-score-btn:hover {
    background: #f5f5f5;
}

.manager-score-btn.active {
    background: #4caf50;
    color: white;
    border-color: #4caf50;
}

.assessment-footer {
    padding: 1rem 1.5rem;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

.loading-skills {
    text-align: center;
    padding: 2rem;
    color: #666;
}

.loading-skills i {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: #667eea;
}
</style>
{% endblock %}

{% block content %}
<div class="team-container">
    <div class="team-header">
        <div>
            <h1>Моя команда</h1>
            <p class="text-muted">Управление оценками сотрудников вашего отдела</p>
        </div>
        <button class="open-add-user-modal btn btn-success"
                data-role="manager"
                data-department-id="{{ current_user.department_id }}"
                data-department-name="{{ current_user.department.name if current_user.department else 'Не назначен' }}">
            <i class="fas fa-user-plus me-2"></i>Добавить сотрудника
        </button>
    </div>

    <div id="addUserModal" class="modal-adduser">
        <div class="modal-adduser-content">
            <div class="modal-adduser-header">
                <h2 id="modaladduserTitle">Добавить пользователя</h2>
                <button class="modal-adduser-close" id="closeadduserModal">&times;</button>
            </div>
            <div class="modal-adduser-body">
                <div class="form-notice" id="formNotice">
                </div>
                
                <form id="addUserForm">
                    <div class="form-field">
                        <label for="full_name">Полное имя *</label>
                        <input type="text" id="full_name" name="full_name" required>
                        <div class="error-message" id="full_name_error"></div>
                    </div>
                    
                    <div class="form-field">
                        <label for="login">Логин *</label>
                        <input type="text" id="login" name="login" required>
                        <div class="error-message" id="login_error"></div>
                    </div>
                    
                    <div class="form-field">
                        <label for="password">Пароль *</label>
                        <input type="password" id="password" name="password" required>
                        <div class="error-message" id="password_error"></div>
                    </div>
                    
                    <div class="form-field">
                        <label for="role">Роль *</label>
                        <select id="role" name="role" required>
                            <option value="">Выберите роль</option>
                            <option value="employee">Сотрудник</option>
                            <option value="manager">Руководитель</option>
                            <option value="hr">HR</option>
                        </select>
                        <div class="error-message" id="role_error"></div>
                    </div>
                    
                    <div class="form-field" id="departmentField">
                        <label for="department_id">Отдел *</label>
                        <select id="department_id" name="department_id" required>
                            <option value="">Выберите отдел</option>
                        </select>
                        <div class="error-message" id="department_id_error"></div>
                    </div>
                    
                    <div class="form-field" id="managerDepartmentInfo" style="display: none;">
                        <label>Отдел</label>
                        <input type="text" id="manager_department_display" class="disabled-field" disabled>
                        <div class="department-info">
                            <i class="fas fa-info-circle"></i>
                            <span>Руководитель может добавлять сотрудников только в свой отдел</span>
                        </div>
                        <input type="hidden" id="manager_department_id" name="department_id">
                    </div>
                </form>
            </div>
            <div class="modal-adduser-footer">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Отмена</button>
                <button type="button" class="btn btn-primary" id="submitBtn">Добавить</button>
            </div>
        </div>
    </div>

    <div class="team-stats">
        <div class="stat-card-team">
            <i class="fas fa-users"></i>
            <h3>{{ team_members|length }}</h3>
            <p>Сотрудников в команде</p>
        </div>
        
        {% set assessed_members = team_members|selectattr('assessments_count', '>', 0)|list %}
        <div class="stat-card-team">
            <i class="fas fa-star"></i>
            <h3>{{ assessed_members|length }}</h3>
            <p>Оценили навыки</p>
        </div>
        
        {% set avg_scores = team_members|map(attribute='avg_manager_score')|select|list %}
        <div class="stat-card-team">
            <i class="fas fa-chart-line"></i>
            <h3>
                {% if avg_scores %}
                    {{ "%.1f"|format(avg_scores|sum / avg_scores|length) }}
                {% else %}
                    0
                {% endif %}
            </h3>
            <p>Средняя самооценка</p>
        </div>
    </div>

    {% if team_members %}
    <div class="team-members-grid">
        {% for member in team_members %}
        <div class="member-card" data-member-id="{{ member.id }}">
            <div class="member-header">
                <div class="member-avatar">
                    {{ member.full_name.split()[0][0] if member.full_name else 'U' }}
                </div>
                <div class="member-info">
                    <h3>{{ member.full_name }}</h3>
                    <div class="role">{{ member.login }}</div>
                </div>
            </div>
            
            <div class="member-stats">
                <div class="stat-item">
                    <div class="stat-value">{{ member.assessments_count }}</div>
                    <div class="stat-label">Оцененных навыков</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value">
                        {% if member.avg_self_score %}
                            {{ "%.1f"|format(member.avg_self_score) }}
                        {% else %}
                            -
                        {% endif %}
                    </div>
                    <div class="stat-label">Средняя самооценка</div>
                </div>
            </div>
            
            <div class="member-actions">
                <!-- Замените ссылку на новую -->
                <a href="{{ url_for('user.view_employee_profile', user_id=member.id) }}" class="btn-view">
                    <i class="fas fa-eye"></i> Посмотреть профиль сотрудника
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-team">
        <i class="fas fa-users-slash"></i>
        <h3>В вашей команде пока нет сотрудников</h3>
        <p>Добавьте сотрудников в отдел, чтобы начать работу</p>
        <button class="open-add-user-modal btn btn-success mt-3"
                data-role="manager"
                data-department-id="{{ current_user.department_id }}"
                data-department-name="{{ current_user.department.name if current_user.department else 'Не назначен' }}">
            <i class="fas fa-user-plus me-2"></i>Добавить первого сотрудника
        </button>
    </div>
    {% endif %}
</div>

<div id="assessmentModal" class="assessment-modal">
    <div class="assessment-content">
        <div class="assessment-header">
            <h3 id="assessmentMemberName">Оценка навыков сотрудника</h3>
            <button class="close-assessment" onclick="closeAssessmentModal()">&times;</button>
        </div>
        
        <div class="assessment-body">
            <div id="skillsLoading" class="loading-skills">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Загрузка навыков...</p>
            </div>
            
            <div id="skillsContainer" class="skills-assessment-grid" style="display: none;">
            </div>
        </div>
        
        <div class="assessment-footer">
            <button class="btn btn-secondary" onclick="closeAssessmentModal()">Отмена</button>
            <button id="saveAssessmentBtn" class="btn btn-primary" onclick="saveAllAssessments()">
                <i class="fas fa-save me-2"></i>Сохранить все оценки
            </button>
        </div>
    </div>
</div>
<div id="assessmentToast" class="toast" style="display: none; position: fixed; bottom: 20px; right: 20px;">
    <i class="fas fa-check-circle"></i>
    <span id="assessmentToastMessage">Оценки сохранены!</span>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/my_team.js') }}"></script>
{% endblock %}